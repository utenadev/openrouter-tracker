# コードベースレビュー報告書 (2026-01-03)

**レビュワー**: Gemini CLI + Gemini 3.0 Pro
**対象**: OpenRouter Tracker リポジトリ全般
**日付**: 2026年1月3日

## 1. 概要
本レポートは、現在のコードベース、設計、およびテスト戦略に対する厳格なレビュー結果をまとめたものです。特にアーキテクチャの信頼性、コードの堅牢性、テストの品質に焦点を当てています。

## 2. アーキテクチャと信頼性に関する指摘

### 2.1 環境変数の管理とドキュメント (重要)
*   **現状**: `fetch_openrouter.py` は `python-dotenv` を使用して `.env` を読み込む実装になっていません。設計意図として `dotenvx` コマンドによる環境変数注入を想定していますが、標準的なPythonスクリプトの実行（`python script.py`）では環境変数が反映されません。
*   **リスク**: ドキュメント（README等）における `dotenvx` 利用の強制力が弱く、開発者や利用者が通常のPython実行を行い、設定が反映されないトラブルに遭遇する可能性が高いです。
*   **推奨**: 
    *   `docs/` や `README.md` に `dotenvx` での実行を**必須**として明記する。
    *   あるいは、開発者の利便性（Developer Experience）向上のため、コード側で `python-dotenv` をフォールバックとして導入し、`dotenvx` なしでも動作するようにする。

### 2.2 データ取得の単一障害点 (SPOF)
*   **現状**: `r.jina.ai` 経由でのデータ取得に完全に依存しています。
*   **リスク**: Jina AI のサービスダウンや、仕様変更（Markdown変換フォーマットの変更）により、即座にツールが機能不全に陥ります。
*   **推奨**: エラー時のログ出力を強化し、可能であれば将来的に直接HTMLをパースする、あるいはOpenRouter公式API（認証あり）への移行を検討する（TODOリストには記載あり）。

### 2.3 「週間トークン数」の定義の曖昧さ
*   **現状**: `weekly_tokens` はAPIから取得した実測値ではなく、ランキング順位に基づいた逆数計算（`10000.0 / rank`）による**擬似スコア**です。
*   **リスク**: 変数名や通知内容が「Tokens」となっているため、ユーザーがこれを実際のトークン使用量と誤認する恐れがあります。
*   **推奨**: 変数名や表示名を `token_score` や `rank_index` 等に変更するか、少なくとも出力メッセージで「推計値（Based on rank）」であることを明示してください。

## 3. コード品質と実装詳細

### 3.1 スクレイピングロジックの脆弱性 (`fetch_openrouter.py`)
*   **現状**: Markdownテーブルの特定カラム順序（名前、入力価格、出力価格、コンテキスト）に依存した実装です。
*   **リスク**: OpenRouterのUI変更によりカラム順序が変わると、誤ったデータを価格として取り込むなどのバグが発生します。
*   **推奨**: テーブルヘッダー行を解析し、カラム名からインデックスを動的に特定するロジックへの変更。

### 3.2 エラーハンドリングの不足
*   **現状**: `config.yaml` 読み込み時に `yaml.safe_load` の例外処理がなく、ファイル破損時にスタックトレースがそのまま表示されます。
*   **推奨**: 設定読み込み部分を `try-except` で囲み、ユーザーフレンドリーなエラーメッセージを表示する。

## 4. テスト品質

### 4.1 テストと本番環境の分離不全
*   **現状**: `tests/test_limit.py` や `test_table_format.py` が実際の外部API（OpenRouter/Jina）にリクエストを送信しています。
*   **リスク**: これらはユニットテストではなく**統合テスト**です。外部サービスの状況によりテストが失敗（Flaky）したり、レート制限に引っかかる可能性があります。CI/CDでの実行には不向きです。
*   **推奨**: `vcrpy` や `requests-mock` を導入し、レスポンスをモック化して、オフラインでも動作する純粋なユニットテストを作成してください。

### 4.2 テスト構造の整理
*   **現状**: `tests/test_script.py` などが `pytest` 標準の形式ではなく、独自の `main()` 実行形式で記述されています。
*   **推奨**: `pytest` フレームワークに準拠したテスト関数への書き換え。

## 5. 推奨アクションプラン

### フェーズ 1: ドキュメントと透明性の向上 (即時対応推奨)
1.  **環境変数**: `dotenvx` の利用手順をドキュメントの「実行方法」セクションの冒頭に移動し強調する。
2.  **データ定義**: ログや通知メッセージに、トークン数がランキングに基づく推計値である旨の注釈を追加する。

### フェーズ 2: 堅牢性の向上
1.  **テスト改善**: 外部APIを叩くテストを特定し、モックを使用するようにリファクタリングする。
2.  **パース改善**: Markdownテーブルのヘッダー解析ロジックを実装する。

### フェーズ 3: アーキテクチャ改善
1.  **ハイブリッドデータ取得**: 現在計画中の「リスト形式」と「テーブル形式」の併用実装を進め、片方のフォーマット変更に対する耐性を高める。
